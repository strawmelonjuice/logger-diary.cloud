<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Logger-Diary Cloud: Client</title>
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
  <link rel="stylesheet" href="css/style.css" content-type="text/css" charset="utf-8" />
  <link rel="stylesheet" href="css/themes/taupe.css" content-type="text/css" charset="utf-8">
  <script src="../node_modules/jquery/dist/jquery.min.js"></script>
  <script src="./early.js"></script>
  <script>
    let env;
    let clientinfo;
    let apiadress;
  </script>
  <script type="module">
    import envi from '../env.json' assert { type: 'json' };
    env = envi;
    import clientinfoio from '../package.json' assert { type: 'json' };
    clientinfo = clientinfoio;
    console.info("Client version: " + clientinfo.version);
    if (envi.devmode === true) {
      window.alert("Developer mode is enabled! Be careful.\n\nDevtools is now unlocked.")
      console.warn("Developer mode is enabled! Be careful.")
      apiadress = env.customServerAdress;
    } else {
      apiadress = "https://electronapi.logger-diary.online/";
    }
  </script>
  <script>
    function apicall(ask, callback) {
      if (localStorage.getItem('loginUsername') != '') {
        const body = {
          username: localStorage.getItem('loginUsername'),
          password: localStorage.getItem('loginPassword'),
          ask: ask
        };
        $.post(apiadress, body, (data, status) => {
          callback(data);
        });
      } else {
        console.error("No credentials!");
      }
    }
    if (localStorage.getItem('loginUsername') == null) {
      console.log("Oh dear. Not logged in!");
      window.location.hash = '/login/';
    }
    function apiping() {
      return new Promise((resolve, reject) => {
        // console.log("Ping");
        $.get(apiadress + "ping/", '', (successResponse) => {
          // console.log("Pong");
          resolve(successResponse);
        }).fail(
          (failResponse) => {
            reject(failResponse);
          }
        );
      })
    }
    var pingres;
    setTimeout(async () => {
        pingres = "no";
        pingres = await apiping();
      }, 13);
    setInterval(async () => {
      pingres = await apiping();
    }, 3000);
    function IfUp() {
      // if ((typeof (document.getElementById("content").dataset.pingres) != 'undefined') && ((document.getElementById("content").dataset.pingres) != '') && ((document.getElementById("content").dataset.pingres) != null)) {
      //   if ((document.getElementById("content").dataset.lastping) > (Date.now() - 3000)) {
      //     if ((document.getElementById("content").getAttribute('data-pingres') == 1)) { return true; } else { return false; }
      //   } else {
      //     (document.getElementById("content")).removeAttribute("data-pingres");
      //     (document.getElementById("content")).removeAttribute("data-lastping");
      //   }
      // } else {
        if (pingres == 'pong') {
          return true;
          // document.getElementById("content").dataset.pingres = 1;
          // document.getElementById("content").dataset.lastping = Date.now();
        } else {
          return false;
          // document.getElementById("content").dataset.pingres = 0;
        };
      // }
    }
  </script>
</head>

<body>
  <header id="titlebar">
    <span id="window-menubutton"><img src="./icons/menu-open.svg" id="menubuttonlogo" class="icon-recolor-main"></span>
    <div id="drag-region">
      <div id="window-title">
        <span>Logger-Diary Client</span>
      </div>

      <div id="window-controls">
        <div class="button" id="min-button">
          <img class="icon icon-recolor-main" srcset="
                icons/min-k-10.png 1x,
                icons/min-k-12.png 1.25x,
                icons/min-k-15.png 1.5x,
                icons/min-k-15.png 1.75x,
                icons/min-k-20.png 2x,
                icons/min-k-20.png 2.25x,
                icons/min-k-24.png 2.5x,
                icons/min-k-30.png 3x,
                icons/min-k-30.png 3.5x
              " draggable="false" />
        </div>
        <div class="button" id="max-button">
          <img class="icon icon-recolor-main" srcset="
                icons/max-k-10.png 1x,
                icons/max-k-12.png 1.25x,
                icons/max-k-15.png 1.5x,
                icons/max-k-15.png 1.75x,
                icons/max-k-20.png 2x,
                icons/max-k-20.png 2.25x,
                icons/max-k-24.png 2.5x,
                icons/max-k-30.png 3x,
                icons/max-k-30.png 3.5x
              " draggable="false" />
        </div>
        <div class="button" id="restore-button">
          <img class="icon icon-recolor-main" srcset="
                icons/restore-k-10.png 1x,
                icons/restore-k-12.png 1.25x,
                icons/restore-k-15.png 1.5x,
                icons/restore-k-15.png 1.75x,
                icons/restore-k-20.png 2x,
                icons/restore-k-20.png 2.25x,
                icons/restore-k-24.png 2.5x,
                icons/restore-k-30.png 3x,
                icons/restore-k-30.png 3.5x
              " draggable="false" />
        </div>
        <div class="button" id="close-button">
          <img class="icon icon-recolor-main" srcset="
                icons/close-k-10.png 1x,
                icons/close-k-12.png 1.25x,
                icons/close-k-15.png 1.5x,
                icons/close-k-15.png 1.75x,
                icons/close-k-20.png 2x,
                icons/close-k-20.png 2.25x,
                icons/close-k-24.png 2.5x,
                icons/close-k-30.png 3x,
                icons/close-k-30.png 3.5x
              " draggable="false" />
        </div>
      </div>
    </div>
  </header>
  <div id="sidenav"></div>
  <main id="content"></main>
  <script src="../renderer.js"></script>
  <script>
    document.body.addEventListener("click", (event) => {
      if (((window.location.hash) === "#/login/") || ((window.location.hash) === "#/gologin/")) {
        function TestCredentialsAndMaybeSave(username, password) {
          console.log("Testing credentials")
          const body = {
            username: username,
            password: password,
            ask: 'access'
          };
          $.post(apiadress, body, (data, status) => {
            if ((JSON.parse(data).test) === "passed") {
              localStorage.setItem('loginUsername', username);
              localStorage.setItem('loginPassword', password);
              console.log("Credentials OK. Response: " + JSON.parse(data).test);
              window.location.hash = '/home/';
            } else {
              console.log("Credentials NOT OK. Response: " + JSON.parse(data).test);
              window.location.hash = '/login-fail/';

            }
          });
        }
      };
      if ((window.location.hash) === "#/login/") {
        if (typeof window.checkCredentialForm != 'undefined') {
          clearInterval(window.checkCredentialForm);
        }
        window.checkCredentialForm = setInterval(() => {
          ;
          if ((window.location.hash) === "#/gologin/") {
            username = urlParams().username;
            password = urlParams().password;
            if (username != '' && password != '') {
              TestCredentialsAndMaybeSave(username, password);
            }
            window.location.hash = '/login/';
          }
        }, 200);
      }
      if ((window.location.hash) === "#/gologin/") {
        username = urlParams().username;
        password = urlParams().password;
        if (username != '' && password != '') {
          TestCredentialsAndMaybeSave(username, password);
        }
        window.location.hash = '/login/';
      }
    });
  </script>
  <script type="module">
    import pageLoader from "../modules/pageload.js";
    document.body.addEventListener("click", (event) => {
      setTimeout(() => {
        if (!IfUp()) {
          window.offlinereason = "API down.";
          window.location.hash = '/offline/';
        } else {
          if (window.offlinereason == "API down.") {
            window.location.hash = '/home/';
          }
        }
        pageLoader();
      }, 100);
      
    });
    window.onoffline = function () {
      window.offlinereason = "Internet unavailable.";
      window.location.hash = '/offline/';
      pageLoader();
    }
    pageLoader();
  </script>
</body>

</html>